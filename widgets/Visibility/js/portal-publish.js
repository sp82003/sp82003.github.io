// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/Visibility/templates/portal-publish.html":'\x3cdiv class\x3d"esriCTFullHeight" data-dojo-attach-point\x3d"resultsPageNode"\x3e\r\n  \x3cdiv class\x3d"esriCTFullWidth esriCTSettingHeader"\x3e\r\n    \x3cdiv class\x3d"esriCTBackButton" title\x3d"${nls.back}"\x3e\r\n      \x3cdiv class\x3d"esriCTItemLeftArrow" data-dojo-attach-point\x3d"resultsPanelBackButton" tabindex\x3d"0"\r\n        aria-label\x3d"${nls.back}" role\x3d"button"\x3e\x3c/div\x3e\r\n      \x3cdiv class\x3d"esriCTTitleDiv esriCTEllipsis" title\x3d"${nls.resultsTitle}"\x3e${nls.resultsTitle}\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"esriCTMainPageRow"\x3e\r\n      \x3c!-- esriCT Layer Name --\x3e\r\n      \x3cdiv class\x3d"esriCTFullWidth esriCTSettingRow"\x3e\r\n        \x3cdiv class\x3d"esriCTInputLabel esriCTEllipsis" title\x3d"${nls.layerName}"\x3e${nls.layerName}\x3c/div\x3e\r\n        \x3cinput aria-label\x3d"${nls.layerName}" class\x3d"esriCTHidden" style\x3d"width: 100%; margin-bottom: 8px;"\r\n          data-dojo-type\x3d"dijit/form/ValidationTextBox" data-dojo-attach-point\x3d"addLayerNameArea"\r\n          data-dojo-props\x3d"regExp:\'[a-zA-Z0-9_ -]*\', invalidMessage:\'${nls.invalidLayerName}\', missingMessage:\'${nls.missingLayerNameMessage}\'"\r\n            required\x3d"true" tabindex\x3d"0" trim\x3d"true"\x3e\x3c/input\x3e\r\n        \x3cselect class\x3d"publishSelect" aria-label\x3d"${nls.layerName}" data-dojo-type\x3d"jimu/dijit/formSelect" tabindex\x3d"0"\r\n          data-dojo-attach-point\x3d"featureLayerList"\x3e\x3c/select\x3e\r\n        \x3cdiv class\x3d"esriCTCheckBoxNode" data-dojo-attach-point\x3d"checkBoxParentContainer"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3c!-- Publish esriCT Button --\x3e\r\n      \x3cdiv class\x3d"esriCTPublishBtnContainer"\x3e\r\n        \x3cdiv class\x3d\'jimu-btn\' data-dojo-attach-point\x3d\'publishButton\' tabindex\x3d"0" aria-label\x3d"${nls.publishBtnLabel}"\r\n          role\x3d"button"\x3e${nls.publishBtnLabel}\x3c/div\x3e\r\n      \x3c/div\x3e\r\n\r\n      \x3c!-- Publishing Message --\x3e\r\n      \x3cdiv class\x3d"esriCTPublishMessage" data-dojo-attach-point\x3d"publishMessage"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare jimu/BaseWidget dijit/_WidgetsInTemplateMixin jimu/dijit/CheckBox dojo/_base/array dojo/_base/lang dojo/json dojo/text!../templates/portal-publish.html dojo/dom-construct dojo/on dojo/dom-class dojo/dom-style esri/arcgis/Portal dojo/Evented ./portal-utils jimu/LayerInfos/LayerInfos esri/layers/FeatureLayer esri/graphic esri/dijit/util/busyIndicator jimu/utils dojo/keys dijit/focus dojo/query dojo/topic dijit/form/ValidationTextBox jimu/dijit/formSelect".split(" "),function(w,
x,y,z,l,a,p,A,B,f,e,C,D,E,m,q,r,t,F,h,k,n,u,v){return w([x,y,E],{templateString:A,baseClass:"jimu-widget-visibility-publish",publishNewLayer:null,busyIndicator:null,fieldsObj:null,postCreate:function(){String.prototype.format||(String.prototype.format=function(){var b=arguments;return this.replace(/{(\d+)}/g,function(c,a){return"undefined"!==typeof b[a]?b[a]:c})});this.fieldsObj={RegionType:{value:"",dataType:"esriFieldTypeInteger"},CenterPoint:{value:this.centerPoint,dataType:"esriFieldTypeString"},
ObservationHeight:{value:this.observerHeight,dataType:"esriFieldTypeDouble"},HeightUnit:{value:this.observerHeightDD,dataType:"esriFieldTypeString"},MinObservationDistance:{value:this.minObsRange,dataType:"esriFieldTypeDouble"},MaxObservationDistance:{value:this.maxObsRange,dataType:"esriFieldTypeDouble"},DistanceUnit:{value:this.distanceUnitDD,dataType:"esriFieldTypeString"},FOVStartAngle:{value:this.fovStartAngle,dataType:"esriFieldTypeDouble"},FOVEndAngle:{value:this.fovEndAngle,dataType:"esriFieldTypeDouble"},
AngleUnits:{value:this.angleUnits,dataType:"esriFieldTypeString"}};this.fields={RegionType:"",CenterPoint:this.centerPoint,ObservationHeight:this.observerHeight,HeightUnit:this.observerHeightDD,MinObservationDistance:this.minObsRange,MaxObservationDistance:this.maxObsRange,DistanceUnit:this.distanceUnitDD,FOVStartAngle:this.fovStartAngle,FOVEndAngle:this.fovEndAngle,AngleUnits:this.angleUnits};this.publishNewLayer=new z({checked:!1,label:this.nls.publishToNewLayer},B.create("div",{},this.checkBoxParentContainer));
this.own(f(this.publishNewLayer,"change",a.hitch(this,this._onCheckboxClicked)));this._populateSelectList(this.featureLayerList,this._layerList,!0);0===this.featureLayerList.options.length&&(this.publishNewLayer.setValue(!0),e.add(this.checkBoxParentContainer,"esriCTHidden"));!this.config.hasOwnProperty("operationalLayer")||this.config.hasOwnProperty("operationalLayer")&&this.config.operationalLayer.hasOwnProperty("name")&&""===this.config.operationalLayer.name?(e.add(this.featureLayerList.domNode,
"esriCTHidden"),this.publishNewLayer.setValue(!0),e.remove(this.addLayerNameArea.domNode,"esriCTHidden")):(e.remove(this.featureLayerList.domNode,"esriCTHidden"),this.publishNewLayer.setValue(!1),e.add(this.addLayerNameArea.domNode,"esriCTHidden"));this.own(f(this.resultsPanelBackButton,"click",a.hitch(this,function(){this.emit("displayMainPageOnBack")})));this.own(f(this.resultsPanelBackButton,"keydown",a.hitch(this,function(b){b.keyCode!==k.ENTER&&b.keyCode!==k.SPACE||this.emit("displayMainPageOnBack")})));
this.own(f(this.publishButton,"click",a.hitch(this,function(){if(this.publishNewLayer.checked&&!this.addLayerNameArea.isValid())this.publishMessage.innerHTML=this.nls.missingLayerNameMessage;else{this.publishMessage.innerHTML="";var b={layerName:this.publishNewLayer.checked?this.addLayerNameArea.value:this.featureLayerList.getValue(),url:"",itemId:"",serviceItemId:""};if(!this.publishNewLayer.checked){var a=this._layerList.filter(function(a){return a.name===b.layerName},this);1===a.length&&(b.url=
a[0].url,b.itemId=a[0].id,b.serviceItemId=p.parse(a[0]._json).serviceItemId)}this._initSaveToPortal(b)}})));this.own(f(this.publishButton,"keydown",a.hitch(this,function(b){if(b.keyCode===k.ENTER||b.keyCode===k.SPACE)if(this.publishNewLayer.checked&&!this.addLayerNameArea.isValid())this.publishMessage.innerHTML=this.nls.missingLayerNameMessage,this._setFirstLastFocusNodes();else{this.publishMessage.innerHTML="";var a={layerName:this.publishNewLayer.checked?this.addLayerNameArea.value:this.featureLayerList.getValue(),
url:"",itemId:"",serviceItemId:"",map:this.map,appConfig:this.appConfig,renderer:this._renderer,publishMessage:this.publishMessage,nls:this.nls,graphics:this.ThreatArea.graphics};this.publishNewLayer.checked||(b=this._layerList.filter(function(b){return b.name===a.layerName},this),1===b.length&&(a.url=b[0].url,a.itemId=b[0].id,a.serviceItemId=p.parse(b[0]._json).serviceItemId));this._initSaveToPortal(a)}})));this.own(v.subscribe("WIDGET_RESIZE",a.hitch(this,this._onWidgetResize)));this.own(f(this.featureLayerList,
"change",a.hitch(this,function(){this._onWidgetResize()})))},startup:function(){this.busyIndicator=F.create({target:this.parentNode.parentNode.parentNode.parentNode,backgroundOpacity:0})},_onWidgetResize:function(){var a=u(".dijitValidationTextBoxLabel",this.featureLayerList.domNode);0<a.length&&C.set(a[0],"width",this.publishButton.clientWidth-53+"px")},_onCheckboxClicked:function(){this.publishNewLayer.checked?(e.add(this.featureLayerList.domNode,"esriCTHidden"),e.remove(this.addLayerNameArea.domNode,
"esriCTHidden"),this.addLayerNameArea.reset(),this.addLayerNameArea.focus()):(e.add(this.addLayerNameArea.domNode,"esriCTHidden"),e.remove(this.featureLayerList.domNode,"esriCTHidden"));this._addLayerToMap=this.publishNewLayer.checked},_populateSelectList:function(b,c,d){var g=[];d&&(g=l.filter(c,function(a){return"esriGeometryPolygon"===a.geometryType},this));c=0<g.length?g:c;l.forEach(c,a.hitch(this,function(a){a.url&&"Feature Layer"===a.type&&a.capabilities.includes("Create,Delete,Query,Update,Editing")&&
b.addOption({value:a.name,label:h.sanitizeHTML(a.name),selected:!1,id:a.id})}));this.config.hasOwnProperty("operationalLayer")&&this.config.operationalLayer.hasOwnProperty("name")&&""!==this.config.operationalLayer.name?b.setValue(this.config.operationalLayer.name):b.setValue("")},_initSaveToPortal:function(b){var c=b.layerName;(new D.Portal(this.appConfig.portalUrl)).signIn().then(a.hitch(this,function(d){var g=d.credential.token,e=d.orgId,G=d.username;if("org_user"===d.role)this.publishMessage.innerHTML=
h.sanitizeHTML(this.nls.createService.format(this.nls.userRole)),this._setFirstLastFocusNodes();else if(b.url){d=new r(b.url+"?token\x3d"+g,{id:b.layerName,outFields:["*"]});d._wabProperties={itemLayerInfo:{portalUrl:this.appConfig.portalUrl,itemId:b.itemId}};this.busyIndicator.show();var f=[];this.graphics.forEach(function(b){if(void 0!==b.attributes&&b.attributes.hasOwnProperty("type")){var c=a.clone(this.fields);c.RegionType="visible"===b.attributes.regionType?1:0;f.push(new t(b.geometry,null,
c))}},this);d.applyEdits(f,null,null).then(a.hitch(this,function(){v.publish("moveMap",!1);this.publishMessage.innerHTML=this.nls.successfullyPublished.format('\x3cbr /\x3e\x3ca href\x3d"'+this.appConfig.portalUrl+"home/item.html?id\x3d"+b.serviceItemId+'" target\x3d"_blank"\x3e')+"\x3c/a\x3e";this._reset()})).otherwise(a.hitch(this,function(a){this.publishMessage.innerHTML=a.message;this._reset()}));this.busyIndicator.hide();this._setFirstLastFocusNodes()}else{var k=this.appConfig.portalUrl+"sharing/content/users/"+
G+"/createService";m.isNameAvailable(this.appConfig.portalUrl+"sharing/rest/portals/"+e+"/isServiceNameAvailable",g,c).then(a.hitch(this,function(b){b.available?(this.busyIndicator.show(),m.createFeatureService(k,g,m.getFeatureServiceParams(c,this.map)).then(a.hitch(this,function(b){if(b.success){var d=b.serviceurl.replace(/rest/g,"rest/admin")+"/addToDefinition";m.addDefinitionToService(d,g,m.getLayerParams(c,this.map,this._renderer,this.nls)).then(a.hitch(this,function(d){if(d.success){d=new r(b.serviceurl+
"/0?token\x3d"+g,{id:c,outFields:["*"]});d._wabProperties={itemLayerInfo:{portalUrl:this.appConfig.portalUrl,itemId:b.itemId}};this.map.addLayer(d);var e;if(d.loaded)e=q.getInstanceSync().getLayerInfoById(c),e.enablePopup();else d.on("load",a.hitch(this,function(){e=q.getInstanceSync().getLayerInfoById(c);e.enablePopup()}));var f=[];l.forEach(this.graphics,function(b){if(void 0!==b.attributes&&b.attributes.hasOwnProperty("type")){var d=a.clone(this.fields);d.RegionType="visible"===b.attributes.regionType?
1:0;f.push(new t(b.geometry,null,d))}},this);d.applyEdits(f,null,null).then(a.hitch(this,function(){this._reset()})).otherwise(a.hitch(this,function(){this._reset()}));this.busyIndicator.hide();this.publishMessage.innerHTML=this.nls.successfullyPublished.format('\x3cbr /\x3e\x3ca role\x3d"link" tabindex\x3d0 aria-label\x3d"'+this.nls.successfullyPublished+'" href\x3d"'+this.appConfig.portalUrl+"home/item.html?id\x3d"+b.itemId+'" target\x3d"_blank"\x3e')+"\x3c/a\x3e";this._setFirstLastFocusNodes()}}),
a.hitch(this,function(b){this.busyIndicator.hide();this.publishMessage.innerHTML=h.sanitizeHTML(this.nls.addToDefinition.format(b.message));this._setFirstLastFocusNodes()}))}else this.busyIndicator.hide(),this.publishMessage.innerHTML=h.sanitizeHTML(this.nls.unableToCreate.format(c)),this._setFirstLastFocusNodes()}),a.hitch(this,function(b){this.busyIndicator.hide();this.publishMessage.innerHTML=h.sanitizeHTML(this.nls.createService.format(b.message));this._setFirstLastFocusNodes()}))):(this.busyIndicator.hide(),
this.publishMessage.innerHTML=this.nls.layerNameExists)}))}}),a.hitch(this,function(b){this.busyIndicator.hide();this.publishMessage.innerHTML=b.message;this._setFirstLastFocusNodes()}))},_reset:function(){this.graphicsLayer.clear();this.graphics=[];this.graphicsLayer.refresh()},_setFirstLastFocusNodes:function(){h.initFirstFocusNode(this.parentNode,this.resultsPanelBackButton);n.focus(this.resultsPanelBackButton);h.initLastFocusNode(this.parentNode,this.publishButton);var b=u("a",this.publishMessage)[0];
""!==this.publishMessage.innerHTML&&b?(h.initLastFocusNode(this.parentNode,this.publishMessage),n.focus(b)):""===this.publishMessage.innerHTML&&n.focus(this.resultsPanelBackButton)},_matchLayerFields:function(b,c){var d={},e=Object.keys(this.fieldsObj);l.forEach(c,a.hitch(this,function(c){l.forEach(e,a.hitch(this,function(a){if(c.name.toLowerCase()===a.toLowerCase()&&(c.type===this.fieldsObj[a].dataType||"esriFieldTypeString"===c.type)){var e=this.fieldsObj[a].value;"esriFieldTypeString"===c.type&&
50>c.length&&"string"===typeof this.fieldsObj[a].value&&(e=this.fieldsObj[a].value.substr(0,c.length));d[c.name]="RegionType"===a?b:e}}))}));return d}})});